<!-- templates/travel/operations.html -->
{% extends 'travel/base.html' %}

{% block title %}Operaciones Día - ClMundo{% endblock %}

{% block extra_css %}
.kanban-column { min-height: 500px; }
.status-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}
.status-confirmed { background-color: #dcfce7; color: #16a34a; }
.status-pending { background-color: #ffedd5; color: #ea580c; }
.status-en-route { background-color: #dbeafe; color: #1d4ed8; }
.status-completed { background-color: #e0f2fe; color: #0369a1; }
.status-cancelled { background-color: #fee2e2; color: #dc2626; }
{% endblock %}

{% block body_class %}bg-gray-100 min-h-screen{% endblock %}

{% block content %}
<header class="bg-white shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center mr-2">
                <i data-feather="compass" class="text-white w-4 h-4"></i>
            </div>
            <span class="font-semibold text-gray-800">Operaciones Día</span>
        </div>
        <div class="text-sm text-gray-600">{{ today|date:"j M Y" }}</div>
    </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Arribos Hoy -->
        <div class="kanban-column bg-white rounded-xl shadow-sm p-4">
            <h2 class="font-semibold text-gray-800 mb-4 flex items-center">
                <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                Arribos Hoy
                <span class="ml-2 bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">{{ arrivals_today.count }}</span>
            </h2>
            
            <div class="space-y-3">
                {% for arrival in arrivals_today %}
                <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-medium text-gray-800">{{ arrival.trip.customer.user.get_full_name }}</h3>
                        <span class="status-badge status-{{ arrival.status }}">{{ arrival.get_status_display }}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-3">
                        <div class="flex items-center mb-1">
                            <i data-feather="plane" class="w-3 h-3 mr-2"></i>
                            <span>{{ arrival.service.name }} - {{ arrival.scheduled_datetime|time:"H:i" }}</span>
                        </div>
                        <div class="flex items-center">
                            <i data-feather="users" class="w-3 h-3 mr-2"></i>
                            <span>{{ arrival.trip.total_passengers }} pasajero{{ arrival.trip.total_passengers|pluralize }}</span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="updateStatus({{ arrival.id }}, 'en_route')" class="flex-1 bg-blue-600 text-white text-xs py-2 px-3 rounded-lg flex items-center justify-center">
                            <i data-feather="navigation" class="w-3 h-3 mr-1"></i>
                            En camino
                        </button>
                        <button class="flex-1 bg-gray-200 text-gray-700 text-xs py-2 px-3 rounded-lg flex items-center justify-center">
                            <i data-feather="phone" class="w-3 h-3 mr-1"></i>
                            Llamar
                        </button>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-8">No hay arribos programados para hoy</p>
                {% endfor %}
            </div>
        </div>

        <!-- En Curso -->
        <div class="kanban-column bg-white rounded-xl shadow-sm p-4">
            <h2 class="font-semibold text-gray-800 mb-4 flex items-center">
                <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                En Curso
                <span class="ml-2 bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">{{ in_progress.count }}</span>
            </h2>
            
            <div class="space-y-3">
                {% for segment in in_progress %}
                <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-green-500">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-medium text-gray-800">{{ segment.trip.customer.user.get_full_name }}</h3>
                        <span class="status-badge status-{{ segment.status }}">{{ segment.get_status_display }}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-3">
                        <div class="flex items-center mb-1">
                            <i data-feather="truck" class="w-3 h-3 mr-2"></i>
                            <span>{{ segment.service.name }}</span>
                        </div>
                        <div class="flex items-center">
                            <i data-feather="clock" class="w-3 h-3 mr-2"></i>
                            <span>ETA: 15 min</span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="flex-1 bg-gray-200 text-gray-700 text-xs py-2 px-3 rounded-lg flex items-center justify-center">
                            <i data-feather="map" class="w-3 h-3 mr-1"></i>
                            Ver ruta
                        </button>
                        <button class="flex-1 bg-gray-200 text-gray-700 text-xs py-2 px-3 rounded-lg flex items-center justify-center">
                            <i data-feather="phone" class="w-3 h-3 mr-1"></i>
                            Llamar
                        </button>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-8">No hay servicios en curso</p>
                {% endfor %}
            </div>
        </div>

        <!-- Incidencias -->
        <div class="kanban-column bg-white rounded-xl shadow-sm p-4">
            <h2 class="font-semibold text-gray-800 mb-4 flex items-center">
                <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                Incidencias
                <span class="ml-2 bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">{{ active_incidents.count }}</span>
            </h2>
            
            <div class="space-y-3">
                {% for incident in active_incidents %}
                <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-red-500">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-medium text-gray-800">{{ incident.segment.service.name }}</h3>
                        <span class="status-badge status-cancelled">{{ incident.get_severity_display }}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-3">
                        <div class="flex items-center mb-1">
                            <i data-feather="alert-triangle" class="w-3 h-3 mr-2 text-red-500"></i>
                            <span>{{ incident.title }}</span>
                        </div>
                        <div class="flex items-center">
                            <i data-feather="users" class="w-3 h-3 mr-2"></i>
                            <span>{{ incident.segment.trip.total_passengers }} pasajero{{ incident.segment.trip.total_passengers|pluralize }} afectado{{ incident.segment.trip.total_passengers|pluralize }}</span>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="resolveIncident({{ incident.id }})" class="flex-1 bg-blue-600 text-white text-xs py-2 px-3 rounded-lg flex items-center justify-center">
                            <i data-feather="calendar" class="w-3 h-3 mr-1"></i>
                            Resolver
                        </button>
                        <button class="flex-1 bg-gray-200 text-gray-700 text-xs py-2 px-3 rounded-lg flex items-center justify-center">
                            <i data-feather="message-circle" class="w-3 h-3 mr-1"></i>
                            Notificar
                        </button>
                    </div>
                </div>
                {% empty %}
                <p class="text-gray-500 text-center py-8">No hay incidencias activas</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="mt-8 bg-white rounded-xl shadow-sm p-6">
        <h2 class="font-semibold text-gray-800 mb-4">Métricas del día</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-4 bg-blue-50 rounded-lg">
                <div class="text-2xl font-bold text-blue-600 mb-1">{{ metrics.total_arrivals }}</div>
                <div class="text-sm text-gray-600">Arribos totales</div>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
                <div class="text-2xl font-bold text-green-600 mb-1">{{ metrics.confirmed_arrivals }}</div>
                <div class="text-sm text-gray-600">Confirmados</div>
            </div>
            <div class="text-center p-4 bg-yellow-50 rounded-lg">
                <div class="text-2xl font-bold text-yellow-600 mb-1">{{ metrics.pending_arrivals }}</div>
                <div class="text-sm text-gray-600">Pendientes</div>
            </div>
            <div class="text-center p-4 bg-red-50 rounded-lg">
                <div class="text-2xl font-bold text-red-600 mb-1">{{ metrics.incidents_count }}</div>
                <div class="text-sm text-gray-600">Incidencias</div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
// Actualizar estado de segmento
function updateStatus(segmentId, newStatus) {
    fetch(`/api/segment/${segmentId}/status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || '{{ csrf_token }}'
        },
        body: `status=${newStatus}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error actualizando estado');
        }
    });
}

// Resolver incidencia
function resolveIncident(incidentId) {
    if (confirm('¿Marcar esta incidencia como resuelta?')) {
        // Aquí iría la lógica para resolver incidencia
        alert('Funcionalidad en desarrollo');
    }
}

// Auto-refresh cada 30 segundos
setTimeout(() => {
    location.reload();
}, 30000);
{% endblock %}