<!-- templates/travel/staff_incident_detail.html -->
{% extends 'travel/base.html' %}

{% block title %}Gestión Incidencia #{{ incident.id }} - Staff{% endblock %}

{% block extra_css %}
.timeline-item {
    position: relative;
    padding-left: 2rem;
}
.timeline-item:before {
    content: '';
    position: absolute;
    left: 8px;
    top: 8px;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #e5e7eb;
}
.timeline-item.completed:before {
    background: #10b981;
}
.timeline-item.active:before {
    background: #3b82f6;
}
{% endblock %}

{% block body_class %}bg-gray-100 min-h-screen{% endblock %}

{% block content %}
<header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center">
            <a href="{% url 'staff_incidents_dashboard' %}" class="p-1 rounded-lg hover:bg-gray-100 mr-3">
                <i data-feather="arrow-left" class="text-gray-600 w-5 h-5"></i>
            </a>
            <div>
                <h1 class="font-semibold text-gray-800">Incidencia #{{ incident.id }}</h1>
                <div class="text-sm text-gray-500">{{ incident.segment.trip.customer.user.get_full_name }}</div>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <span class="px-3 py-1 text-sm font-medium rounded-full
                {% if incident.severity == 'critical' %}bg-red-100 text-red-800
                {% elif incident.severity == 'high' %}bg-orange-100 text-orange-800
                {% elif incident.severity == 'medium' %}bg-yellow-100 text-yellow-800
                {% else %}bg-green-100 text-green-800{% endif %}">
                {{ incident.get_severity_display }}
            </span>
            <span class="px-3 py-1 text-sm font-medium rounded-full
                {% if incident.status == 'open' %}bg-red-100 text-red-800
                {% elif incident.status == 'in_progress' %}bg-yellow-100 text-yellow-800
                {% elif incident.status == 'resolved' %}bg-green-100 text-green-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ incident.get_status_display }}
            </span>
        </div>
    </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Información principal -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Detalles del incidente -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-start justify-between mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-2">{{ incident.title }}</h2>
                        <div class="flex items-center gap-4 text-sm text-gray-500">
                            <span>Reportado: {{ incident.reported_at|date:"j M Y, H:i" }}</span>
                            <span>Ocurrió: {{ incident.incident_datetime|date:"j M Y, H:i" }}</span>
                            <span>Categoría: {{ incident.get_category_display }}</span>
                        </div>
                    </div>
                    {% if incident.is_overdue %}
                    <span class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded-full">VENCIDA</span>
                    {% endif %}
                </div>
                
                <div class="prose max-w-none mb-6">
                    <h4 class="text-lg font-medium text-gray-800 mb-3">Descripción</h4>
                    <p class="text-gray-600 leading-relaxed">{{ incident.description }}</p>
                    
                    {% if incident.location %}
                    <div class="mt-4 flex items-center text-gray-600">
                        <i data-feather="map-pin" class="w-4 h-4 mr-2"></i>
                        <span>Ubicación: {{ incident.location }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="mt-4 flex items-center text-gray-600">
                        <i data-feather="users" class="w-4 h-4 mr-2"></i>
                        <span>Pasajeros afectados: {{ incident.affected_passengers }}</span>
                    </div>
                    
                    {% if incident.reporter_contact %}
                    <div class="mt-2 flex items-center text-gray-600">
                        <i data-feather="phone" class="w-4 h-4 mr-2"></i>
                        <span>Contacto: {{ incident.reporter_contact }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Servicio afectado -->
                <div class="border-t pt-6">
                    <h4 class="text-lg font-medium text-gray-800 mb-3">Servicio afectado</h4>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h5 class="font-medium text-gray-800">{{ incident.segment.service.name }}</h5>
                                <p class="text-sm text-gray-600">{{ incident.segment.scheduled_datetime|date:"j M Y, H:i" }}</p>
                                {% if incident.segment.pickup_location %}
                                <p class="text-sm text-gray-500">{{ incident.segment.pickup_location }}</p>
                                {% endif %}
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                                    {{ incident.segment.service.get_service_type_display }}
                                </span>
                                <p class="text-sm text-gray-500 mt-1">{{ incident.segment.voucher_code }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Resolución actual -->
                {% if incident.resolution_notes %}
                <div class="border-t pt-6">
                    <h4 class="text-lg font-medium text-gray-800 mb-3">Resolución aplicada</h4>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-green-700">{{ incident.resolution_notes }}</p>
                        {% if incident.resolved_at %}
                        <p class="text-sm text-green-600 mt-2">Resuelto el {{ incident.resolved_at|date:"j M Y, H:i" }}</p>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Formulario de gestión -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-6">Gestión del caso</h3>
                
                <form method="POST" class="space-y-6">
                    {% csrf_token %}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                            {{ form.status }}
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Asignar a</label>
                            {{ form.assigned_to }}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notas de resolución</label>
                        {{ form.resolution_notes }}
                        <p class="text-sm text-gray-500 mt-1">Describe la solución aplicada (visible para el cliente)</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notas internas</label>
                        {{ form.internal_notes }}
                        <p class="text-sm text-gray-500 mt-1">Notas para el equipo interno (no visible para el cliente)</p>
                    </div>
                    
                    <div class="flex items-center">
                        {{ form.requires_followup }}
                        <label for="{{ form.requires_followup.id_for_label }}" class="ml-2 text-sm text-gray-700">
                            Requiere seguimiento adicional
                        </label>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                            <i data-feather="save" class="w-4 h-4 mr-2"></i>
                            Actualizar caso
                        </button>
                        
                        {% if incident.status != 'resolved' and incident.status != 'closed' %}
                        <button type="button" onclick="quickResolve()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center">
                            <i data-feather="check" class="w-4 h-4 mr-2"></i>
                            Resolver rápido
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Sidebar con información adicional -->
        <div class="space-y-6">
            <!-- Timeline del caso -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Timeline del caso</h3>
                <div class="space-y-4">
                    <div class="timeline-item completed">
                        <div class="text-sm">
                            <div class="font-medium text-gray-800">Incidencia reportada</div>
                            <div class="text-gray-500">{{ incident.reported_at|date:"j M Y, H:i" }}</div>
                            <div class="text-xs text-gray-400 mt-1">Por {{ incident.segment.trip.customer.user.get_full_name }}</div>
                        </div>
                    </div>
                    
                    {% if incident.assigned_to %}
                    <div class="timeline-item {% if incident.status != 'open' %}completed{% else %}active{% endif %}">
                        <div class="text-sm">
                            <div class="font-medium text-gray-800">Caso asignado</div>
                            <div class="text-gray-500">A {{ incident.assigned_to.get_full_name }}</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if incident.status == 'in_progress' %}
                    <div class="timeline-item active">
                        <div class="text-sm">
                            <div class="font-medium text-gray-800">En progreso</div>
                            <div class="text-gray-500">Trabajando en la solución</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if incident.resolved_at %}
                    <div class="timeline-item completed">
                        <div class="text-sm">
                            <div class="font-medium text-gray-800">Caso resuelto</div>
                            <div class="text-gray-500">{{ incident.resolved_at|date:"j M Y, H:i" }}</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if incident.customer_satisfaction %}
                    <div class="timeline-item completed">
                        <div class="text-sm">
                            <div class="font-medium text-gray-800">Cliente calificó</div>
                            <div class="text-gray-500">{{ incident.customer_satisfaction }}/5 estrellas</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Información del cliente -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Información del cliente</h3>
                <div class="space-y-3">
                    <div class="flex items-center">
                        <i data-feather="user" class="w-4 h-4 text-gray-400 mr-3"></i>
                        <div>
                            <div class="font-medium">{{ incident.segment.trip.customer.user.get_full_name }}</div>
                            <div class="text-sm text-gray-500">{{ incident.segment.trip.customer.user.email }}</div>
                        </div>
                    </div>
                    
                    {% if incident.segment.trip.customer.phone %}
                    <div class="flex items-center">
                        <i data-feather="phone" class="w-4 h-4 text-gray-400 mr-3"></i>
                        <div>
                            <div class="font-medium">{{ incident.segment.trip.customer.phone }}</div>
                            <div class="text-sm text-gray-500">Teléfono principal</div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="flex items-center">
                        <i data-feather="map-pin" class="w-4 h-4 text-gray-400 mr-3"></i>
                        <div>
                            <div class="font-medium">{{ incident.segment.trip.destination }}</div>
                            <div class="text-sm text-gray-500">Destino del viaje</div>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <i data-feather="users" class="w-4 h-4 text-gray-400 mr-3"></i>
                        <div>
                            <div class="font-medium">{{ incident.segment.trip.total_passengers }} pasajeros</div>
                            <div class="text-sm text-gray-500">Total del grupo</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t">
                    <div class="flex space-x-2">
                        <button onclick="contactCustomer('phone')" class="flex-1 px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm flex items-center justify-center">
                            <i data-feather="phone" class="w-4 h-4 mr-1"></i>
                            Llamar
                        </button>
                        <button onclick="contactCustomer('email')" class="flex-1 px-3 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 text-sm flex items-center justify-center">
                            <i data-feather="mail" class="w-4 h-4 mr-1"></i>
                            Email
                        </button>
                        <button onclick="contactCustomer('whatsapp')" class="flex-1 px-3 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-sm flex items-center justify-center">
                            <i data-feather="message-circle" class="w-4 h-4 mr-1"></i>
                            WhatsApp
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Métricas del caso -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Métricas</h3>
                <div class="space-y-4">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Tiempo de respuesta</span>
                        <span class="font-medium {% if incident.is_overdue %}text-red-600{% endif %}">
                            {{ incident.response_time }}h
                        </span>
                    </div>
                    
                    <div class="flex justify-between">
                        <span class="text-gray-600">Prioridad</span>
                        <span class="font-medium
                            {% if incident.severity == 'critical' %}text-red-600
                            {% elif incident.severity == 'high' %}text-orange-600
                            {% elif incident.severity == 'medium' %}text-yellow-600
                            {% else %}text-green-600{% endif %}">
                            {{ incident.get_severity_display }}
                        </span>
                    </div>
                    
                    {% if incident.customer_satisfaction %}
                    <div class="flex justify-between">
                        <span class="text-gray-600">Satisfacción</span>
                        <div class="flex items-center">
                            <span class="font-medium mr-1">{{ incident.customer_satisfaction }}</span>
                            <div class="flex">
                                {% for i in "12345"|make_list %}
                                    <span class="text-sm {% if forloop.counter <= incident.customer_satisfaction %}text-yellow-400{% else %}text-gray-300{% endif %}">★</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if incident.requires_followup %}
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <div class="flex items-center text-yellow-800">
                            <i data-feather="flag" class="w-4 h-4 mr-2"></i>
                            <span class="text-sm font-medium">Requiere seguimiento</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Acciones rápidas -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Acciones rápidas</h3>
                <div class="space-y-2">
                    <button onclick="escalateIncident()" class="w-full px-4 py-2 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 text-left flex items-center">
                        <i data-feather="arrow-up" class="w-4 h-4 mr-3"></i>
                        Escalar a supervisor
                    </button>
                    <button onclick="duplicateIncident()" class="w-full px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 text-left flex items-center">
                        <i data-feather="copy" class="w-4 h-4 mr-3"></i>
                        Marcar como duplicado
                    </button>
                    <button onclick="createReport()" class="w-full px-4 py-2 bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-100 text-left flex items-center">
                        <i data-feather="file-text" class="w-4 h-4 mr-3"></i>
                        Generar reporte
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
function quickResolve() {
    const status = document.querySelector('select[name="status"]');
    const resolution = document.querySelector('textarea[name="resolution_notes"]');
    
    status.value = 'resolved';
    if (!resolution.value) {
        resolution.value = 'Problema resuelto satisfactoriamente.';
        resolution.focus();
    }
}

function contactCustomer(method) {
    const customer = {
        email: '{{ incident.segment.trip.customer.user.email }}',
        phone: '{{ incident.segment.trip.customer.phone }}',
        name: '{{ incident.segment.trip.customer.user.get_full_name }}'
    };
    
    switch(method) {
        case 'phone':
            if (customer.phone) {
                window.open(`tel:${customer.phone}`);
            } else {
                alert('No hay teléfono registrado');
            }
            break;
        case 'email':
            window.open(`mailto:${customer.email}?subject=Incidencia #{{ incident.id }} - {{ incident.title }}`);
            break;
        case 'whatsapp':
            if (customer.phone) {
                const phone = customer.phone.replace(/\s+/g, '').replace('+', '');
                window.open(`https://wa.me/${phone}?text=Hola ${customer.name}, te contacto sobre la incidencia #{{ incident.id }}`);
            } else {
                alert('No hay teléfono registrado');
            }
            break;
    }
}

function escalateIncident() {
    if (confirm('¿Escalar esta incidencia a un supervisor?')) {
        // Implementar lógica de escalamiento
        alert('Funcionalidad en desarrollo');
    }
}

function duplicateIncident() {
    if (confirm('¿Marcar como duplicado?')) {
        // Implementar lógica de duplicado
        alert('Funcionalidad en desarrollo');
    }
}

function createReport() {
    // Implementar generación de reporte
    alert('Generando reporte...');
}

// Auto-refresh cada 30 segundos para casos activos
{% if incident.status == 'open' or incident.status == 'in_progress' %}
setTimeout(() => {
    location.reload();
}, 30000);
{% endif %}
{% endblock %}